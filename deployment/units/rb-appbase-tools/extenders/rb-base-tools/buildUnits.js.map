{"version":3,"sources":["../../../../../units/rb-appbase-tools/extenders/rb-base-tools/buildUnits.js"],"names":["fs","fsWithCallbacks","promises","prettierESLintOptions","eslintConfig","eslintRC","prettierOptions","packageJSON","prettier","reRemoveComments","RegExp","createGraphQLSchema","units","result","schema","introspectionQuery","errors","Error","JSON","stringify","printedSchema","replace","taskPromises","path","resolve","Promise","all","createRouteFile","fileName","imports","exports","routesAppFrame","concat","text","join","createRoutes","routesAppFrameImports","routesRootImports","routesAppFrameExports","routesRootExports","unitName","endsWith","routesDir","routeFileNames","readdir","routeFileName","startsWith","route","substring","length","push","buildUnits"],"mappings":"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","sourcesContent":["// @flow\n\nimport fsWithCallbacks from 'fs'\nimport path from 'path'\n\nimport { graphql } from 'graphql'\nimport { introspectionQuery, printSchema } from 'graphql/utilities'\nimport prettierESLint from 'prettier-eslint'\n\nimport ensureFileContent from '../../../rb-base-server/ensureFileContent'\n// $AssureFlow Not sure why it gives an error. The file does exist\nimport eslintRC from '../../../../.eslintrc.json'\nimport fsExists from '../../../rb-base-server/fsExists'\nimport packageJSON from '../../../../package.json'\nimport schema from '../../../rb-appbase-server/graphql/schema'\n\nconst fs = fsWithCallbacks.promises\n\nconst prettierESLintOptions = { eslintConfig: eslintRC, prettierOptions: packageJSON.prettier }\n\n// It is a complete mystery to me why the comments are encased in \"\"\" but the relay\n// compiler does not like them. Either way, this sanitizes the schema and removes the comment.\nconst reRemoveComments = new RegExp( '\"\"\"[^\"]*\"\"\"', 'g' )\n\nasync function createGraphQLSchema( units: Array<string> ) {\n  const result = await graphql( schema, introspectionQuery )\n  if ( result.errors )\n    throw new Error( 'Failed introspecting schema: ' + JSON.stringify( result.errors, null, 2 ) )\n\n  const printedSchema = printSchema( schema ).replace( reRemoveComments, '#' )\n\n  const taskPromises = [\n    ensureFileContent(\n      path.resolve( './units/_configuration/rb-base-server/graphql/schema.json' ),\n      null,\n      JSON.stringify( result, null, 2 ),\n      true,\n    ),\n    ensureFileContent( path.resolve( 'schema.graphql' ), null, printedSchema, true ),\n  ]\n\n  await Promise.all( taskPromises )\n}\n\nasync function createRouteFile( fileName: string, imports: Array<string>, exports: Array<string> ) {\n  let routesAppFrame = [ '// @flow', '' ]\n  routesAppFrame = routesAppFrame.concat( imports )\n  routesAppFrame = routesAppFrame.concat([ '', 'export default [' ])\n  routesAppFrame = routesAppFrame.concat( exports )\n  routesAppFrame = routesAppFrame.concat([ ']' ])\n\n  await ensureFileContent(\n    fileName,\n    null,\n    prettierESLint({ text: routesAppFrame.join( '\\r\\n' ), ...prettierESLintOptions }),\n    true,\n  )\n}\n\nasync function createRoutes( units: Array<string> ) {\n  const routesAppFrameImports = []\n  const routesRootImports = []\n  const routesAppFrameExports = []\n  const routesRootExports = []\n\n  for ( let unitName of units )\n    if ( unitName.endsWith( '-webapp' ) ) {\n      const routesDir = path.resolve( './units', unitName )\n      if ( await fsExists( routesDir ) ) {\n        const routeFileNames = await fs.readdir( routesDir )\n\n        for ( let routeFileName of routeFileNames ) {\n          if ( routeFileName.endsWith( '.jsx' ) )\n            if ( routeFileName.startsWith( 'routeAppFrame' ) ) {\n              const route = routeFileName.substring( 0, routeFileName.length - 4 )\n              routesAppFrameImports.push(\n                'import ' + route + ' from \\'../../' + unitName + '/' + route + '\\'',\n              )\n              routesAppFrameExports.push( '  ' + route + ',' )\n            } else if ( routeFileName.startsWith( 'routeRoot' ) ) {\n              const route = routeFileName.substring( 0, routeFileName.length - 4 )\n              routesRootImports.push(\n                'import ' + route + ' from \\'../../' + unitName + '/' + route + '\\'',\n              )\n              routesRootExports.push( '  ' + route + ',' )\n            }\n        }\n      }\n    }\n\n  await Promise.all([\n    createRouteFile(\n      path.resolve( './units/_configuration/rb-appbase-webapp/routesAppFrame.js' ),\n      routesAppFrameImports,\n      routesAppFrameExports,\n    ),\n    createRouteFile(\n      path.resolve( './units/_configuration/rb-appbase-webapp/routesRoot.js' ),\n      routesRootImports,\n      routesRootExports,\n    ),\n  ])\n}\n\nexport default ( async function buildUnits( units: Array<string> ) {\n  const taskPromises = [ createGraphQLSchema( units ), createRoutes( units ) ]\n\n  await Promise.all( taskPromises )\n})\n"],"file":"buildUnits.js"}
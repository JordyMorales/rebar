{"version":3,"sources":["../../../units/urb-base-server/logServerRequest.js"],"names":["logServerRequest","req","res","next","loggingFunction","oldWriteRes","write","oldEndRes","end","chunksRes","chunk","push","Buffer","from","apply","arguments","responseBody","concat","toString","clientIP","headers","connection","remoteAddress","user","codeFoundriesInjected","requestAndResponse","cookies","query","body","response"],"mappings":";;;AAGwBA,gB,EAHxB;AAEA;AACe,SAASA,gBAAT,CAA2BC,GAA3B,EAAgCC,GAAhC,EAAqCC,IAArC,EAA2CC,eAA3C,EAA6D,CAC1E,MAAMC,cAAcH,IAAII,KAAxB,CACA,MAAMC,YAAYL,IAAIM,GAAtB;;AAEA,QAAMC,YAAY,EAAlB;;AAEAP,MAAII,KAAJ,GAAY,UAAUI,KAAV,EAAkB;AAC5BD,cAAUE,IAAV,CAAgBC,OAAOC,IAAP,CAAaH,KAAb,CAAhB;AACAL,gBAAYS,KAAZ,CAAmBZ,GAAnB,EAAwBa,SAAxB;AACD,GAHD;;AAKAb,MAAIM,GAAJ,GAAU,UAAUE,KAAV,EAAkB;AAC1B,QAAKA,KAAL,EAAaD,UAAUE,IAAV,CAAgBC,OAAOC,IAAP,CAAaH,KAAb,CAAhB;;AAEb,QAAIM,eAAeJ,OAAOK,MAAP,CAAeR,SAAf,EAA2BS,QAA3B,CAAqC,MAArC,CAAnB;;AAEA;AACA,UAAMC,WAAWlB,IAAImB,OAAJ,CAAY,WAAZ,KAA4BnB,IAAIoB,UAAJ,CAAeC,aAA5D;;AAEA,QAAIC,IAAJ;AACA,QAAKrB,IAAIsB,qBAAJ,IAA6BtB,IAAIsB,qBAAJ,CAA0BD,IAA5D;AACEA,WAAOrB,IAAIsB,qBAAJ,CAA0BD,IAAjC,CADF;AAEKA,WAAO,gBAAP;;AAEL,UAAME,qBAAqB;AACzBL,eAASnB,IAAImB,OADY;AAEzBM,eAASzB,IAAIyB,OAFY;AAGzBH,YAAMA,IAHmB;AAIzBI,aAAO1B,IAAI2B,IAJc;AAKzBC,gBAAUb,YALe;AAMzBG,cANyB,EAA3B;;;AASAf,oBAAiBqB,kBAAjB;;AAEAlB,cAAUO,KAAV,CAAiBZ,GAAjB,EAAsBa,SAAtB;AACD,GAzBD;;AA2BAZ;AACD","file":"logServerRequest.js","sourcesContent":["// @flow weak\n\n// Function to log requests\nexport default function logServerRequest( req, res, next, loggingFunction ) {\n  const oldWriteRes = res.write\n  const oldEndRes = res.end\n\n  const chunksRes = []\n\n  res.write = function( chunk ) {\n    chunksRes.push( Buffer.from( chunk ) )\n    oldWriteRes.apply( res, arguments )\n  }\n\n  res.end = function( chunk ) {\n    if ( chunk ) chunksRes.push( Buffer.from( chunk ) )\n\n    var responseBody = Buffer.concat( chunksRes ).toString( 'utf8' )\n\n    // Determine client ID - either placed in the headers by Nginx, or the IP the request is coming from\n    const clientIP = req.headers['x-real-ip'] || req.connection.remoteAddress\n\n    let user\n    if ( res.codeFoundriesInjected && res.codeFoundriesInjected.user )\n      user = res.codeFoundriesInjected.user\n    else user = 'not determined'\n\n    const requestAndResponse = {\n      headers: req.headers,\n      cookies: req.cookies,\n      user: user,\n      query: req.body,\n      response: responseBody,\n      clientIP,\n    }\n\n    loggingFunction( requestAndResponse )\n\n    oldEndRes.apply( res, arguments )\n  }\n\n  next()\n}\n"]}
{"version":3,"sources":["../../../units/urb-base-server/serverAuth.js"],"names":["require","load","serverAuth","use","json","req","res","next","login","objectManager","siteInformation","UserAccount_Identifier","body","toLowerCase","User_Secret","arr_UserAccount","getObjectList","UserAccount_artifact_id","artifact_id","length","status","error","a_User","getOneObject","id","UserAccount_User_id","Promise","resolve","compare","err","passwordMatch","a_UserSession","UserSession_artifact_id","UserSession_User_id","UserSession_Start","Date","UserSession_Expired","add","codeFoundriesInjected","user","UserToken1","encode","session_id","process","env","JWT_SECRET","cookie","httpOnly","success","UserToken2","message","post","createuser","Error","User_PasswordHash","hash","accountNameIsValidEmail","User_Email","Object","assign","User_artifact_id","Math","random","toString","substring","User_DisplayName","assignPrimaryKey","a_UserAccount","UserAccount_Type","all","console","log","UserSession","remove","expires"],"mappings":"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","file":"serverAuth.js","sourcesContent":["// @flow\n\nimport bcryptjs from 'bcryptjs'\nimport bodyParser from 'body-parser'\nimport express from 'express'\nimport jwt from 'jwt-simple'\n\nimport authExtensions from '../_configuration/urb-base-server/authExtensions'\nimport delayPromise from '../urb-base-universal/delayPromise'\nimport getNewUser from '../_configuration/urb-base-server/graphql/model/getNewUser'\nimport { validateEmail } from '../urb-base-universal/validation'\nimport { requestLoggerAuth } from '../_configuration/urb-base-server/requestLoggers'\n\nimport { getUserAndSessionIDByUserToken1 } from './checkCredentials'\nimport logServerRequest from './logServerRequest'\nimport { getObjectManager } from './graphql/ObjectManager'\n\n// Read environment\nrequire( 'dotenv' ).load()\n\nconst serverAuth = express()\n\nserverAuth.use( bodyParser.json() )\nserverAuth.use( ( req, res, next ) => logServerRequest( req, res, next, requestLoggerAuth ) )\n\n//\n\nasync function login( req, res ) {\n  const objectManager = await getObjectManager( req, res )\n  if ( objectManager.siteInformation ) {\n    const UserAccount_Identifier = req.body.UserAccount_Identifier.toLowerCase()\n    const User_Secret = req.body.User_Secret\n\n    await delayPromise( 1000 ) // Wait for a second to hamper a possible potential brute force attack\n\n    try {\n      const arr_UserAccount = await objectManager.getObjectList( 'UserAccount', {\n        UserAccount_artifact_id: objectManager.siteInformation.artifact_id,\n        UserAccount_Identifier: UserAccount_Identifier,\n      })\n\n      if ( arr_UserAccount.length === 0 ) {\n        res.status( 401 ).json({ error: 'User account not found' })\n      } else {\n        const a_User = await objectManager.getOneObject( 'User', {\n          id: arr_UserAccount[0].UserAccount_User_id,\n        })\n        if (\n          await new Promise( resolve =>\n            bcryptjs.compare( User_Secret, a_User.User_Secret, ( err, passwordMatch ) =>\n              resolve( passwordMatch ),\n            ),\n          )\n        ) {\n          // Create user session object\n          const a_UserSession = {\n            UserSession_artifact_id: objectManager.siteInformation.artifact_id, // Get previously assigned primary key\n            UserSession_User_id: a_User.id,\n            UserSession_Start: new Date(),\n            UserSession_Expired: false,\n          }\n          // Addsession to database\n          objectManager.add( 'UserSession', a_UserSession )\n          res.codeFoundriesInjected = { user: a_User }\n          // User has authenticated correctly thus we create a JWT token ith the session.\n          const UserToken1 = jwt.encode(\n            // $FlowIssue - id will be filled in by ObjectManager.add\n            { session_id: a_UserSession.id },\n            process.env.JWT_SECRET,\n          )\n          res.cookie( 'UserToken1', UserToken1, { httpOnly: true })\n          res.json({ success: true, UserToken2: a_User.UserToken2 })\n        } else res.status( 401 ).json({ error: 'Incorrect password' })\n      }\n    } catch ( error ) {\n      res.status( 401 ).json({ error: error.message })\n    }\n  }\n}\nserverAuth.post( '/login', login )\n\nasync function createuser( req, res ) {\n  const objectManager = await getObjectManager( req, res )\n  if ( objectManager.siteInformation ) {\n    const UserAccount_Identifier = req.body.UserAccount_Identifier.toLowerCase()\n    const User_Secret = req.body.User_Secret\n    try {\n      const arr_UserAccount = await objectManager.getObjectList( 'UserAccount', {\n        UserAccount_artifact_id: objectManager.siteInformation.artifact_id,\n        UserAccount_Identifier: UserAccount_Identifier,\n      })\n      if ( arr_UserAccount.length > 0 ) throw new Error( 'User account already exists' )\n      const User_PasswordHash = await new Promise( resolve =>\n        bcryptjs.hash( User_Secret, 8, ( err, hash ) => resolve( hash ) ),\n      )\n      // If account name looks like email address, use it as email\n      const accountNameIsValidEmail = validateEmail( UserAccount_Identifier )\n      const User_Email = accountNameIsValidEmail ? UserAccount_Identifier : ''\n      // Create the user object\n      const a_User = Object.assign( getNewUser( objectManager.siteInformation.artifact_id ), {\n        User_artifact_id: objectManager.siteInformation.artifact_id,\n        UserToken2:\n          Math.random()\n            .toString( 36 )\n            .substring( 2 ) +\n          Math.random()\n            .toString( 36 )\n            .substring( 2 ),\n        User_Secret: User_PasswordHash,\n        User_DisplayName: UserAccount_Identifier,\n        User_Email: User_Email,\n      })\n      objectManager.assignPrimaryKey( 'User', a_User )\n      // Create user session object\n      const a_UserSession = {\n        UserSession_artifact_id: objectManager.siteInformation.artifact_id,\n        // Get previously assigned primary key\n        UserSession_User_id: a_User.id,\n        UserSession_Start: new Date(),\n        UserSession_Expired: false,\n      }\n      // Create user account object\n      const a_UserAccount = {\n        UserAccount_artifact_id: objectManager.siteInformation.artifact_id,\n        // Get previously assigned primary key\n        UserAccount_User_id: a_User.id,\n        UserAccount_Identifier: UserAccount_Identifier,\n        UserAccount_Type: 'un',\n      }\n      // Add user and session to database\n      await Promise.all([\n        objectManager.add( 'User', a_User ),\n        objectManager.add( 'UserSession', a_UserSession ),\n        objectManager.add( 'UserAccount', a_UserAccount ),\n      ])\n\n      res.codeFoundriesInjected = { user: a_User }\n\n      // User has been created thus we create a JWT token.\n      const UserToken1 = jwt.encode(\n        // $FlowIssue - id will be filled in by ObjectManager.add\n        { session_id: a_UserSession.id },\n        process.env.JWT_SECRET,\n      )\n      // Set cookie and return\n      res.cookie( 'UserToken1', UserToken1, { httpOnly: true })\n      res.json({ success: true })\n    } catch ( error ) {\n      console.log( error )\n      res.status( 401 ).json({ error: '' + error.message })\n    }\n  }\n}\nserverAuth.post( '/createuser', createuser )\n\nserverAuth.post( '/logout', async( req, res ) => {\n  const objectManager = await getObjectManager( req, res )\n  const UserSession = ( await getUserAndSessionIDByUserToken1( objectManager, req ) ).UserSession\n  await objectManager.remove( 'UserSession', { id: UserSession.id })\n  res.cookie( 'UserToken1', '', { httpOnly: true, expires: new Date( 1 ) })\n  res.json({ success: true })\n})\n\n// Add extensions - custom configurations\nauthExtensions( serverAuth )\nexport default serverAuth\n"]}
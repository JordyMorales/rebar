{"version":3,"sources":["../../../units/urb-base-server/server.js"],"names":["require","load","port","process","env","PORT","Error","host","HOST","log","name","version","NODE_ENV","PUBLIC_URL","process_title","title","process_pid","pid","local_ip","server","use","req","res","next","setHeader","set","serverHealthz","express","static","path","resolve","__dirname","maxAge","ObjectManager","initializePersisters","listen","startDevelopmentServer","localIPDevelopmentServer"],"mappings":";;;AAGA;;AAEA,4B;;AAEA,kC;AACA,0C;AACA,6C;;AAEA;AACA,oE;;AAEA,0C;AACA,4B;AACA;AACA,gD;AACA,gD,2JAA4C;;AAE5C;;AAEA;AApBA;AAqBAA,QAAS,QAAT,EAAoBC,IAApB;AAEA,MAAMC,OAAOC,QAAQC,GAAR,CAAYC,IAAzB;AACA,IAAKH,QAAQ,IAAR,IAAgB,OAAOA,IAAP,KAAgB,QAArC;AACE,MAAM,IAAII,KAAJ,CAAW,4EAAX,CAAN;;AAEF,MAAMC,OAAOJ,QAAQC,GAAR,CAAYI,IAAzB;AACA,IAAKD,QAAQ,IAAR,IAAgB,OAAOA,IAAP,KAAgB,QAArC;AACE,MAAM,IAAID,KAAJ,CAAW,4EAAX,CAAN,C,CAAgG;;AAElGG,cAAIA,GAAJ,CAAS,MAAT,EAAiB,sBAAjB,EAAyC;AACvCC,QAAMA,aADiC;AAEvCC,WAASA,gBAF8B;AAGvCC,YAAUT,QAAQC,GAAR,CAAYQ,QAHiB;AAIvCJ,QAAML,QAAQC,GAAR,CAAYI,IAJqB;AAKvCH,QAAMF,QAAQC,GAAR,CAAYC,IALqB;AAMvCQ,cAAYV,QAAQC,GAAR,CAAYS,UANe;AAOvCC,iBAAeX,QAAQY,KAPgB;AAQvCC,eAAab,QAAQc,GARkB;AASvCC,YAAU,2BAT6B,EAAzC;;;AAYA;AACA;;AAEA;AACA,MAAMC,SAAS,wBAAf;;AAEA;AACAA,OAAOC,GAAP,CAAY,UAAUC,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA2B;AACrC;AACAD,MAAIE,SAAJ,CAAe,6BAAf,EAA8CrB,QAAQC,GAAR,CAAYS,UAA1D;;AAEA;AACAS,MAAIE,SAAJ,CAAe,8BAAf,EAA+C,wCAA/C;;AAEA;AACAF,MAAIE,SAAJ,CAAe,8BAAf,EAA+C,+BAA/C;;AAEA;AACA;AACAF,MAAIE,SAAJ,CAAe,kCAAf,EAAmD,IAAnD;;AAEA;AACAD;AACD,CAhBD,E,CAgBG;;AAEHJ,OAAOM,GAAP,CAAY,aAAZ,EAA2B,UAA3B;AACAN,OAAOM,GAAP,CAAY,cAAZ,EAA4B,KAA5B;AACAN,OAAOC,GAAP,CAAY,4BAAZ;AACAD,OAAOC,GAAP,CAAY,6BAAZ,E,CAA6B;;AAE7BD,OAAOC,GAAP,CAAY,UAAZ,EAAwBM,uBAAxB,E,CAAwC;AACxCP,OAAOC,GAAP;AACEO,kBAAQC,MAAR,CAAgBC,eAAKC,OAAL,CAAcC,YAAY,kDAA1B,CAAhB,EAAgG;AAC9FC,UAAQ,MAAM,KADgF,CACzE;AADyE,CAAhG,CADF;;;AAMA;AACA,uBAASb,MAAT;;AAEAc,wBAAcC,oBAAd,CAAoC,KAApC,EAA2C,MAAM;AAC/C;AACA;AACA,MAAK/B,QAAQC,GAAR,CAAYQ,QAAZ,KAAyB,YAA9B,EAA6C;AAC3C;AACAO,WAAOgB,MAAP,CAAejC,IAAf,EAAqBK,IAArB;AACD,GAHD,MAGO;AACL;AACA6B,2BAAwBlC,IAAxB,EAA8B,WAA9B;AACA;AACA,QAAKK,SAAS,WAAd,EAA4B6B,uBAAwBlC,IAAxB,EAA8BK,IAA9B;AAC7B;AACF,CAZD;;AAcA,SAAS6B,sBAAT,CAAiClC,IAAjC,EAAuCK,IAAvC,EAA8C;AAC5C,QAAM8B,2BAA2B,wBAAjC;AACAA,2BAAyBjB,GAAzB,CAA8BD,MAA9B;AACAkB,2BAAyBF,MAAzB,CAAiCjC,IAAjC,EAAuCK,IAAvC;AACD","file":"server.js","sourcesContent":["// @flow\n\n// In order to use ES7 async/await\nimport 'babel-polyfill'\n\nimport path from 'path'\n\nimport express from 'express'\nimport compression from 'compression'\nimport cookieParser from 'cookie-parser'\n\nimport { name, version } from '../_configuration/package'\nimport servers from '../_configuration/urb-base-server/servers'\n\nimport getLocalIP from './getLocalIP'\nimport log from './log'\nimport { initializeObjectCache } from './ObjectCache'\nimport ObjectManager from './ObjectManager'\nimport serverHealthz from './serverHealthz' // Health check endpoint server\n\n//\n\n// Read environment\nrequire( 'dotenv' ).load()\n\nconst port = process.env.PORT\nif ( port == null || typeof port !== 'string' )\n  throw new Error( 'urb-base-server/server.js requires the environment variable PORT to be set' )\n\nconst host = process.env.HOST\nif ( host == null || typeof host !== 'string' )\n  throw new Error( 'urb-base-server/server.js requires the environment variable HOST to be set' ) // Log startup information\n\nlog.log( 'info', 'Starting application', {\n  name: name,\n  version: version,\n  NODE_ENV: process.env.NODE_ENV,\n  HOST: process.env.HOST,\n  PORT: process.env.PORT,\n  PUBLIC_URL: process.env.PUBLIC_URL,\n  process_title: process.title,\n  process_pid: process.pid,\n  local_ip: getLocalIP(),\n})\n\n// Get object cache ready\ninitializeObjectCache()\n\n// Main router\nconst server = express()\n\n// Add headers\nserver.use( function( req, res, next ) {\n  // Website you wish to allow to connect\n  res.setHeader( 'Access-Control-Allow-Origin', process.env.PUBLIC_URL )\n\n  // Request methods you wish to allow\n  res.setHeader( 'Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE' )\n\n  // Request headers you wish to allow\n  res.setHeader( 'Access-Control-Allow-Headers', 'X-Requested-With,content-type' )\n\n  // Set to true if you need the website to include cookies in the requests sent\n  // to the API (e.g. in case you use sessions)\n  res.setHeader( 'Access-Control-Allow-Credentials', true )\n\n  // Pass to next layer of middleware\n  next()\n}) // Configure main router\n\nserver.set( 'trust proxy', 'loopback' )\nserver.set( 'x-powered-by', false )\nserver.use( compression() )\nserver.use( cookieParser() ) // GraphQL server requires this\n\nserver.use( '/healthz', serverHealthz ) // Static public files server\nserver.use(\n  express.static( path.resolve( __dirname + '/../_configuration/urb-base-server/public_files/' ), {\n    maxAge: 365 * 86400, // one year\n  }),\n)\n\n// Initialize server extenders\nservers( server )\n\nObjectManager.initializePersisters( false, () => {\n  // Serve - work differently in development and production. In production only the\n  // specified host serves\n  if ( process.env.NODE_ENV === 'production' ) {\n    // Production - serve as told\n    server.listen( port, host )\n  } else {\n    // Development server - localhost. Always run on localhost\n    startDevelopmentServer( port, '127.0.0.1' )\n    // Development server - on a specific IP, if different from localhost\n    if ( host !== '127.0.0.1' ) startDevelopmentServer( port, host )\n  }\n})\n\nfunction startDevelopmentServer( port, host ) {\n  const localIPDevelopmentServer = express()\n  localIPDevelopmentServer.use( server )\n  localIPDevelopmentServer.listen( port, host )\n}\n"]}
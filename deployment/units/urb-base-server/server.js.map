{"version":3,"sources":["../../../units/urb-base-server/server.js"],"names":["require","load","port","process","env","PORT","Error","host","HOST","log","name","version","NODE_ENV","PUBLIC_URL","process_title","title","process_pid","pid","local_ip","server","use","req","res","next","setHeader","set","serverHealthz","express","static","path","resolve","__dirname","maxAge","ObjectManager","initializePersisters","listen","startDevelopmentServer","localIPDevelopmentServer"],"mappings":"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","sourcesContent":["// @flow\n\n// In order to use ES7 async/await\n//import 'babel-polyfill'\n\nimport path from 'path'\n\nimport express from 'express'\nimport compression from 'compression'\nimport cookieParser from 'cookie-parser'\n\nimport { name, version } from '../_configuration/package'\nimport servers from '../_configuration/urb-base-server/servers'\n\nimport getLocalIP from './getLocalIP'\nimport log from './log'\nimport { initializeObjectCache } from './ObjectCache'\nimport ObjectManager from './ObjectManager'\nimport serverHealthz from './serverHealthz' // Health check endpoint server\n\n//\n\n// Read environment\nrequire( 'dotenv' ).load()\n\nconst port = process.env.PORT\nif ( port == null || typeof port !== 'string' )\n  throw new Error( 'urb-base-server/server.js requires the environment variable PORT to be set' )\n\nconst host = process.env.HOST\nif ( host == null || typeof host !== 'string' )\n  throw new Error( 'urb-base-server/server.js requires the environment variable HOST to be set' ) // Log startup information\n\nlog.log( 'info', 'Starting application', {\n  name: name,\n  version: version,\n  NODE_ENV: process.env.NODE_ENV,\n  HOST: process.env.HOST,\n  PORT: process.env.PORT,\n  PUBLIC_URL: process.env.PUBLIC_URL,\n  process_title: process.title,\n  process_pid: process.pid,\n  local_ip: getLocalIP(),\n})\n\n// Get object cache ready\ninitializeObjectCache()\n\n// Main router\nconst server = express()\n\n// Add headers\nserver.use( function( req, res, next ) {\n  // Website you wish to allow to connect\n  res.setHeader( 'Access-Control-Allow-Origin', process.env.PUBLIC_URL )\n\n  // Request methods you wish to allow\n  res.setHeader( 'Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE' )\n\n  // Request headers you wish to allow\n  res.setHeader( 'Access-Control-Allow-Headers', 'X-Requested-With,content-type' )\n\n  // Set to true if you need the website to include cookies in the requests sent\n  // to the API (e.g. in case you use sessions)\n  res.setHeader( 'Access-Control-Allow-Credentials', true )\n\n  // Pass to next layer of middleware\n  next()\n}) // Configure main router\n\nserver.set( 'trust proxy', 'loopback' )\nserver.set( 'x-powered-by', false )\nserver.use( compression() )\nserver.use( cookieParser() ) // GraphQL server requires this\n\nserver.use( '/healthz', serverHealthz ) // Static public files server\nserver.use(\n  express.static( path.resolve( __dirname + '/../_configuration/urb-base-server/public_files/' ), {\n    maxAge: 365 * 86400, // one year\n  }),\n)\n\n// Initialize server extenders\nservers( server )\n\nObjectManager.initializePersisters( false, () => {\n  // Serve - work differently in development and production. In production only the\n  // specified host serves\n  if ( process.env.NODE_ENV === 'production' ) {\n    // Production - serve as told\n    server.listen( port, host )\n  } else {\n    // Development server - localhost. Always run on localhost\n    startDevelopmentServer( port, '127.0.0.1' )\n    // Development server - on a specific IP, if different from localhost\n    if ( host !== '127.0.0.1' ) startDevelopmentServer( port, host )\n  }\n})\n\nfunction startDevelopmentServer( port, host ) {\n  const localIPDevelopmentServer = express()\n  localIPDevelopmentServer.use( server )\n  localIPDevelopmentServer.listen( port, host )\n}\n"],"file":"server.js"}
{"version":3,"sources":["../../../units/urb-base-tools/MasterWriter.js"],"names":["copyFileAsync","fs","copyFile","mkdirAsync","mkdir","MasterWriter","constructor","basePath","directories","Map","arrPromises","ensureRelativePathExistsHelper","filePath","has","console","log","creating","path","resolve","err","code","set","ensureRelativePathExists","destinationRelative","arrPath","split","pathAccumulated","ix","length","sourceAbsolute","push","writeFile","fileContent","executeQueue","Promise","all"],"mappings":";;AAEA,wB;AACA,4B;AACA;;AAEA,wD;;AAEA;AACA,MAAMA,gBAAgB,qBAAWC,aAAGC,QAAd,CAAtB;AACA,MAAMC,aAAa,qBAAWF,aAAGG,KAAd,CAAnB;;AAEe,MAAMC,YAAN,CAAmB;;;;;;AAMhCC,cAAaC,QAAb,EAAgC;AAC9B,SAAKA,QAAL,GAAgBA,QAAhB;AACA,SAAKC,WAAL,GAAmB,IAAIC,GAAJ,EAAnB;AACA,SAAKC,WAAL,GAAmB,EAAnB;AACD,GAV+B,CAGhC;;AASA,QAAMC,8BAAN,CAAsCC,QAAtC,EAAyD;AACvD,QAAK,CAAC,KAAKJ,WAAL,CAAiBK,GAAjB,CAAsBD,QAAtB,CAAN,EAAyC;AACvCE,cAAQC,GAAR,CAAY,EAAEC,UAAU,IAAZ,EAAkBJ,QAAlB,EAAZ;;AAEA,UAAI;AACF,cAAMT,WAAYc,eAAKC,OAAL,CAAc,KAAKX,QAAnB,EAA6BK,QAA7B,CAAZ,CAAN;AACD,OAFD,CAEE,OAAQO,GAAR,EAAc;AACd,YAAKA,IAAIC,IAAJ,KAAa,QAAlB,EAA6B,MAAMD,GAAN;AAC9B;;AAED,WAAKX,WAAL,CAAiBa,GAAjB,CAAsBT,QAAtB,EAAgC,IAAhC;AACD;AACF;;AAED,QAAMU,wBAAN,CAAgCC,mBAAhC,EAA8D;AAC5D,UAAMC,UAAUD,oBAAoBE,KAApB,CAA2B,GAA3B,CAAhB;;AAEA,SAAM,IAAIC,kBAAkB,EAAtB,EAA0BC,KAAK,CAArC,EAAwCA,KAAKH,QAAQI,MAArD,EAA6DD,IAA7D,EAAoE;AAClE,YAAM,KAAKhB,8BAAL,CAAqCe,eAArC,CAAN;AACAA,yBAAmBF,QAAQG,EAAR,IAAc,GAAjC;AACD;AACF;;AAED,QAAMzB,QAAN,CAAgB2B,cAAhB,EAAwCN,mBAAxC,EAAsE;AACpE,UAAM,KAAKD,wBAAL,CAA+BC,mBAA/B,CAAN;;AAEA,SAAKb,WAAL,CAAiBoB,IAAjB,CAAuB9B,cAAe6B,cAAf,EAA+B,KAAKtB,QAAL,GAAgB,GAAhB,GAAsBgB,mBAArD,CAAvB;AACD;;AAED,QAAMQ,SAAN,CAAiBR,mBAAjB,EAA8CS,WAA9C,EAAoE;AAClE,UAAM,KAAKV,wBAAL,CAA+BC,mBAA/B,CAAN;;AAEA,SAAKb,WAAL,CAAiBoB,IAAjB;AACE,qCAAmB,KAAKvB,QAAL,GAAgB,GAAhB,GAAsBgB,mBAAzC,EAA8D,IAA9D,EAAoES,WAApE,CADF;;AAGD;;AAED,QAAMC,YAAN,GAAqB;AACnB,UAAMC,QAAQC,GAAR,CAAa,KAAKzB,WAAlB,CAAN;AACA,SAAKA,WAAL,GAAmB,EAAnB;AACD,GApD+B,C,kBAAbL,Y","file":"MasterWriter.js","sourcesContent":["// @flow\n\nimport fs from 'fs'\nimport path from 'path'\nimport { promisify } from 'util'\n\nimport ensureFileContent from './ensureFileContent'\n\n// $FlowIssue\nconst copyFileAsync = promisify( fs.copyFile )\nconst mkdirAsync = promisify( fs.mkdir )\n\nexport default class MasterWriter {\n  basePath: string\n  directories: Map<string, boolean>\n  // $FlowIssue\n  arrPromises: Array<Promise>\n\n  constructor( basePath: string ) {\n    this.basePath = basePath\n    this.directories = new Map()\n    this.arrPromises = []\n  }\n\n  async ensureRelativePathExistsHelper( filePath: string ) {\n    if ( !this.directories.has( filePath ) ) {\n      console.log({ creating: true, filePath })\n\n      try {\n        await mkdirAsync( path.resolve( this.basePath, filePath ) )\n      } catch ( err ) {\n        if ( err.code !== 'EEXIST' ) throw err\n      }\n\n      this.directories.set( filePath, true )\n    }\n  }\n\n  async ensureRelativePathExists( destinationRelative: string ) {\n    const arrPath = destinationRelative.split( '/' )\n\n    for ( let pathAccumulated = '', ix = 0; ix < arrPath.length; ix++ ) {\n      await this.ensureRelativePathExistsHelper( pathAccumulated )\n      pathAccumulated += arrPath[ix] + '/'\n    }\n  }\n\n  async copyFile( sourceAbsolute: string, destinationRelative: string ) {\n    await this.ensureRelativePathExists( destinationRelative )\n\n    this.arrPromises.push( copyFileAsync( sourceAbsolute, this.basePath + '/' + destinationRelative ) )\n  }\n\n  async writeFile( destinationRelative: string, fileContent: string ) {\n    await this.ensureRelativePathExists( destinationRelative )\n\n    this.arrPromises.push(\n      ensureFileContent( this.basePath + '/' + destinationRelative, null, fileContent ),\n    )\n  }\n\n  async executeQueue() {\n    await Promise.all( this.arrPromises )\n    this.arrPromises = []\n  }\n}\n"]}
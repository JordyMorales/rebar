{"version":3,"sources":["../../../units/urb-base-tools/MasterReader.js"],"names":["readdirAsync","readdir","readFileAsync","readFile","statAsync","stat","FileBase","constructor","arrRelativePath","relativePath","join","name","length","File","Directory","arrContents","MasterReader","basePath","directoriesByRelativePath","Map","fileContentsByRelativePath","skipFile","arrAllFiles","setSkipFile","initialize","baseDir","readDirectory","dir","set","dirContent","fileName","substr","fileOrDirToAdd","isFile","file","concat","isDirectory","subDir","Error","JSON","stringify","push","currentContent","get","newContent","toString","getAllFiles","getAllFiledHelper","fileOrDirectory"],"mappings":";;AAEA,wB;AACA,4B;;AAEA,MAAMA,eAAe,qBAAW,aAAGC,OAAd,CAArB;AACA,MAAMC,gBAAgB,qBAAW,aAAGC,QAAd,CAAtB;AACA,MAAMC,YAAY,qBAAW,aAAGC,IAAd,CAAlB;;AAEA,MAAMC,QAAN,CAAe;;;;;AAKbC,cAAaC,eAAb,EAA8C;AAC5C,SAAKA,eAAL,GAAuBA,eAAvB;AACA,SAAKC,YAAL,GAAoBD,gBAAgBE,IAAhB,CAAsB,GAAtB,CAApB;AACA,SAAKC,IAAL,GAAYH,gBAAgBA,gBAAgBI,MAAhB,GAAyB,CAAzC,CAAZ;AACD,GATY;;;AAYR,MAAMC,IAAN,SAAmBP,QAAnB,CAA4B,E,QAAtBO,I,GAAAA,I;;;;AAIN,MAAMC,SAAN,SAAwBR,QAAxB,CAAiC;;;;AAItCC,cAAaC,eAAb,EAA8C;AAC5C,UAAOA,eAAP;;AAEA,SAAKO,WAAL,GAAmB,EAAnB;AACD,GARqC,C,QAA3BD,S,GAAAA,S;;;AAWE,MAAME,YAAN,CAAmB;;;;;;;;AAQhCT,cAAaU,QAAb,EAAgC;AAC9B,SAAKA,QAAL,GAAgBA,QAAhB;;AAEA,SAAKC,yBAAL,GAAiC,IAAIC,GAAJ,EAAjC;AACA,SAAKC,0BAAL,GAAkC,IAAID,GAAJ,EAAlC;;AAEA,SAAKE,QAAL,GAAgB,MAAM,KAAtB;AACA,SAAKC,WAAL,GAAmB,EAAnB;AACD;;AAEDC,cAAaF,QAAb,EAAkC;AAChC,SAAKA,QAAL,GAAgBA,QAAhB;AACD;;AAED,QAAMG,UAAN,GAAmB;AACjB;AACA,SAAKC,OAAL,GAAe,MAAM,KAAKC,aAAL,CAAmB,EAAnB,CAArB;AACD;;AAED,QAAMA,aAAN,CAAqBlB,eAArB,EAAsD;AACpD,UAAMmB,MAAM,IAAIb,SAAJ,CAAeN,eAAf,CAAZ;AACA,SAAKU,yBAAL,CAA+BU,GAA/B,CAAoCD,IAAIlB,YAAxC,EAAsDkB,GAAtD;;AAEA,UAAME,aAAa,MAAM7B,aAAc,KAAKiB,QAAL,GAAgB,GAAhB,GAAsBU,IAAIlB,YAAxC,CAAzB;AACA,SAAM,IAAIqB,QAAV,IAAsBD,UAAtB,EAAmC;AACjC;AACA,UAAKC,aAAa,WAAlB,EAAgC;;AAEhC;AACA,UAAK,KAAKT,QAAL,CAAeS,QAAf,CAAL,EAAiC;AAC/B;AACD;;AAED;AACA,UAAKA,SAASC,MAAT,CAAiB,CAAjB,EAAoB,CAApB,MAA4B,GAAjC,EAAuC;AACrC;AACD;;AAED,YAAM1B,OAAO,MAAMD,UAAW,KAAKa,QAAL,GAAgB,GAAhB,GAAsBU,IAAIlB,YAA1B,GAAyC,GAAzC,GAA+CqB,QAA1D,CAAnB;;AAEA,UAAIE,cAAJ;;AAEA,UAAK3B,KAAK4B,MAAL,EAAL,EAAqB;AACnB,cAAMC,OAAO,IAAIrB,IAAJ,CAAUL,gBAAgB2B,MAAhB,CAAwBL,QAAxB,CAAV,CAAb;;AAEAE,yBAAiBE,IAAjB;AACD,OAJD,MAIO,IAAK7B,KAAK+B,WAAL,EAAL,EAA0B;AAC/B,cAAMC,SAAS,MAAM,KAAKX,aAAL,CAAoBlB,gBAAgB2B,MAAhB,CAAwBL,QAAxB,CAApB,CAArB;;AAEAE,yBAAiBK,MAAjB;AACD,OAJM;AAKL,YAAM,IAAIC,KAAJ;AACJ,mDAA6CC,KAAKC,SAAL,CAAgBhC,eAAhB,CADzC,CAAN;;;AAIFmB,UAAIZ,WAAJ,CAAgB0B,IAAhB,CAAsBT,cAAtB;AACD;;AAED,WAAOL,GAAP;AACD;;AAED,QAAMxB,QAAN,CAAgB2B,QAAhB,EAAoD;AAClD,UAAMY,iBAAiB,KAAKtB,0BAAL,CAAgCuB,GAAhC,CAAqCb,QAArC,CAAvB;;AAEA,QAAKY,cAAL,EAAsB,OAAOA,cAAP;;AAEtB,UAAME,aAAa,CAAE,MAAM1C,cAAe,KAAKe,QAAL,GAAgB,GAAhB,GAAsBa,QAArC,EAA+C,MAA/C,CAAR,EAAkEe,QAAlE,EAAnB;AACA,SAAKzB,0BAAL,CAAgCQ,GAAhC,CAAqCE,QAArC,EAA+Cc,UAA/C;;AAEA,WAAOA,UAAP;AACD;;AAEDE,gBAAc;AACZ,QAAK,CAAC,KAAKrB,OAAX,EAAqB,MAAM,IAAIa,KAAJ,EAAN;;AAErB,QAAK,KAAKhB,WAAL,CAAiBV,MAAjB,GAA0B,CAA/B,EAAmC,OAAO,KAAKU,WAAZ;;AAEnC,SAAKyB,iBAAL,CAAwB,KAAKtB,OAA7B;;AAEA,WAAO,KAAKH,WAAZ;AACD;;AAEDyB,oBAAmBpB,GAAnB,EAAoC;AAClC,SAAM,IAAIqB,eAAV,IAA6BrB,IAAIZ,WAAjC,EAA+C;AAC7C,UAAKiC,2BAA2BlC,SAAhC,EAA4C;AAC1C;AACA,aAAKiC,iBAAL,CAAwBC,eAAxB;AACD,OAHD,MAGO,IAAKA,2BAA2BnC,IAAhC,EAAuC;AAC5C,aAAKS,WAAL,CAAiBmB,IAAjB,CAAuBO,eAAvB;AACD;AACF;AACF,GAnG+B,C,kBAAbhC,Y","file":"MasterReader.js","sourcesContent":["// @flow\n\nimport fs from 'fs'\nimport { promisify } from 'util'\n\nconst readdirAsync = promisify( fs.readdir )\nconst readFileAsync = promisify( fs.readFile )\nconst statAsync = promisify( fs.stat )\n\nclass FileBase {\n  arrRelativePath: Array<string>\n  relativePath: string\n  name: string\n\n  constructor( arrRelativePath: Array<string> ) {\n    this.arrRelativePath = arrRelativePath\n    this.relativePath = arrRelativePath.join( '/' )\n    this.name = arrRelativePath[arrRelativePath.length - 1]\n  }\n}\n\nexport class File extends FileBase {\n  contentAsString: ?string\n}\n\nexport class Directory extends FileBase {\n  arrContents: Array<FileBase>\n  arrAllFiles: Array<File>\n\n  constructor( arrRelativePath: Array<string> ) {\n    super( arrRelativePath )\n\n    this.arrContents = []\n  }\n}\n\nexport default class MasterReader {\n  arrAllFiles: Array<File>\n  baseDir: ?Directory\n  basePath: string\n  directoriesByRelativePath: Map<string, Directory>\n  fileContentsByRelativePath: Map<string, string>\n  skipFile: Function\n\n  constructor( basePath: string ) {\n    this.basePath = basePath\n\n    this.directoriesByRelativePath = new Map()\n    this.fileContentsByRelativePath = new Map()\n\n    this.skipFile = () => false\n    this.arrAllFiles = []\n  }\n\n  setSkipFile( skipFile: Function ) {\n    this.skipFile = skipFile\n  }\n\n  async initialize() {\n    // And read\n    this.baseDir = await this.readDirectory([])\n  }\n\n  async readDirectory( arrRelativePath: Array<string> ) {\n    const dir = new Directory( arrRelativePath )\n    this.directoriesByRelativePath.set( dir.relativePath, dir )\n\n    const dirContent = await readdirAsync( this.basePath + '/' + dir.relativePath )\n    for ( let fileName of dirContent ) {\n      // Skip DS store iles on mac\n      if ( fileName === '.DS_Store' ) continue\n\n      // Skip files according to passed function\n      if ( this.skipFile( fileName ) ) {\n        continue\n      }\n\n      // Skip . and .. directories\n      if ( fileName.substr( 0, 1 ) === '.' ) {\n        continue\n      }\n\n      const stat = await statAsync( this.basePath + '/' + dir.relativePath + '/' + fileName )\n\n      let fileOrDirToAdd\n\n      if ( stat.isFile() ) {\n        const file = new File( arrRelativePath.concat( fileName ) )\n\n        fileOrDirToAdd = file\n      } else if ( stat.isDirectory() ) {\n        const subDir = await this.readDirectory( arrRelativePath.concat( fileName ) )\n\n        fileOrDirToAdd = subDir\n      } else\n        throw new Error(\n          'MasterReader: Neither file nor directory' + JSON.stringify( arrRelativePath ),\n        )\n\n      dir.arrContents.push( fileOrDirToAdd )\n    }\n\n    return dir\n  }\n\n  async readFile( fileName: string ): Promise<string> {\n    const currentContent = this.fileContentsByRelativePath.get( fileName )\n\n    if ( currentContent ) return currentContent\n\n    const newContent = ( await readFileAsync( this.basePath + '/' + fileName, 'utf8' ) ).toString()\n    this.fileContentsByRelativePath.set( fileName, newContent )\n\n    return newContent\n  }\n\n  getAllFiles() {\n    if ( !this.baseDir ) throw new Error()\n\n    if ( this.arrAllFiles.length > 0 ) return this.arrAllFiles\n\n    this.getAllFiledHelper( this.baseDir )\n\n    return this.arrAllFiles\n  }\n\n  getAllFiledHelper( dir: Directory ) {\n    for ( let fileOrDirectory of dir.arrContents ) {\n      if ( fileOrDirectory instanceof Directory ) {\n        // Sub-dir\n        this.getAllFiledHelper( fileOrDirectory )\n      } else if ( fileOrDirectory instanceof File ) {\n        this.arrAllFiles.push( fileOrDirectory )\n      }\n    }\n  }\n}\n"]}
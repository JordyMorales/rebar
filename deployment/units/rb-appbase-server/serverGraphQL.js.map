{"version":3,"sources":["../../../units/rb-appbase-server/serverGraphQL.js"],"names":["serverGraphQL","use","bodyParser","json","req","res","next","requestLoggerGraphQL","root","objectManager","siteInformation","a_User","User","codeFoundriesInjected","user","schema","rootValue","pretty","graphiql","err","log","level","message","details","status","send","JSON","stringify","error"],"mappings":";;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;;;;AAKA;;;AAGA,6D,8FAHsC;AAEtC;AAGA;AACA,MAAMA,aAAa,GAAG,uBAAtB;;AAEA;AACAA,aAAa,CAACC,GAAd,CAAmBC,oBAAWC,IAAX,EAAnB;;AAEA;AACAH,aAAa,CAACC,GAAd,CAAmB,CAAEG,GAAF,EAAOC,GAAP,EAAYC,IAAZ,KAAsB,+BAAkBF,GAAlB,EAAuBC,GAAvB,EAA4BC,IAA5B,EAAkCC,oCAAlC,CAAzC;;AAEA,eAAeC,IAAf,CAAqBJ,GAArB,EAA0BC,GAA1B,EAA+BC,IAA/B,EAAsC;AACpC,MAAI;AACF,UAAMG,aAAa,GAAG,MAAM,qCAAkBL,GAAlB,EAAuBC,GAAvB,CAA5B;AACA,QAAKI,aAAa,CAACC,eAAnB,EAAqC;AACnC,UAAI;AACF,cAAMC,MAAM,GAAG,CAAE,MAAM,uDAAiCF,aAAjC,EAAgDL,GAAhD,CAAR,EAAgEQ,IAA/E;;AAEAP,QAAAA,GAAG,CAACQ,qBAAJ,GAA4B,EAAEC,IAAI,EAAEH,MAAR,EAA5B;AACA,cAAM,2CAAqBA,MAArB,EAA6BP,GAA7B,CAAN;;AAEA,qCAAa,MAAM;AACjB,iBAAO;AACLW,YAAAA,MAAM,EAAEA,eADH;AAELC,YAAAA,SAAS,EAAEP,aAFN;AAGLQ,YAAAA,MAAM,EAAE,IAHH;AAILC,YAAAA,QAAQ,EAAE,IAJL,EAAP;;AAMD,SAPD,EAOId,GAPJ,EAOSC,GAPT,EAOcC,IAPd;AAQD,OAdD,CAcE,OAAQa,GAAR,EAAc;AACd,yDAA2Bf,GAA3B,EAAgCC,GAAhC,EAAqCc,GAArC,EAA0C,IAA1C;AACD;AACF;AACF,GArBD,CAqBE,OAAQA,GAAR,EAAc;AACdC,iBAAIA,GAAJ,CAAQ,EAAEC,KAAK,EAAE,OAAT,EAAkBC,OAAO,EAAE,gBAA3B,EAA6CC,OAAO,EAAEJ,GAAtD,EAAR;AACAd,IAAAA,GAAG,CAACmB,MAAJ,CAAY,GAAZ,EAAkBC,IAAlB;AACEC,IAAAA,IAAI,CAACC,SAAL,CAAe;AACbC,MAAAA,KAAK,EAAE,mDADM,EAAf,CADF;;;AAKD;AACF;AACD5B,aAAa,CAACC,GAAd,CAAmB,GAAnB,EAAwBO,IAAxB,E;;AAEeR,a","sourcesContent":["// @flow\n\nimport bodyParser from 'body-parser'\nimport express from 'express'\nimport graphQLHTTP from 'express-graphql'\n\nimport log from '../rb-base-server/log'\nimport { requestLoggerGraphQL } from '../_configuration/rb-base-server/requestLoggers'\nimport logServerRequest from '../rb-base-server/logServerRequest'\nimport { getObjectManager } from '../rb-base-server/ObjectManager'\n\nimport {\n  getUserAndSessionIDByUserToken1,\n  verifyUserAuthToken,\n  serveAuthenticationFailed,\n} from './checkCredentials'\nimport schema from './graphql/schema' // Schema for GraphQL server\n\n// Guarantee that all object registrations and schema definitions are executed\nimport '../_configuration/rb-base-server/graphql/_schemas'\n\n// Create router for GraphQL\nconst serverGraphQL = express()\n\n// Set up parser\nserverGraphQL.use( bodyParser.json() )\n\n// Set up logging\nserverGraphQL.use( ( req, res, next ) => logServerRequest( req, res, next, requestLoggerGraphQL ) )\n\nasync function root( req, res, next ) {\n  try {\n    const objectManager = await getObjectManager( req, res )\n    if ( objectManager.siteInformation ) {\n      try {\n        const a_User = ( await getUserAndSessionIDByUserToken1( objectManager, req ) ).User\n\n        res.codeFoundriesInjected = { user: a_User }\n        await verifyUserAuthToken( a_User, req )\n\n        graphQLHTTP( () => {\n          return {\n            schema: schema,\n            rootValue: objectManager,\n            pretty: true,\n            graphiql: true,\n          }\n        })( req, res, next )\n      } catch ( err ) {\n        serveAuthenticationFailed( req, res, err, true )\n      }\n    }\n  } catch ( err ) {\n    log.log({ level: 'error', message: 'Error: GraphQL', details: err })\n    res.status( 500 ).send(\n      JSON.stringify({\n        error: 'An error has occurred while running GraphQL query',\n      }),\n    )\n  }\n}\nserverGraphQL.use( '/', root )\n\nexport default serverGraphQL\n"],"file":"serverGraphQL.js"}